<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Book Detail - Quiet Chatter</title>
    <th:block th:replace="~{fragments/common-assets :: css}"></th:block>
    <style>
        .book-detail-container {
            padding: 1.5rem;
            margin-top: 2rem;
            min-height: 300px; /* ìµœì†Œ ë†’ì´ ì¶”ê°€ */
        }

        .book-image {
            max-width: 100%;
            height: 350px; /* ìŠ¤ì¼ˆë ˆí†¤ì— ë§ì¶˜ ê³ ì • ë†’ì´ */
            object-fit: contain; /* ê³ ì •ëœ ë†’ì´ ë‚´ì—ì„œ ì´ë¯¸ì§€ ë¹„ìœ¨ì„ ì˜¬ë°”ë¥´ê²Œ ì¡°ì • */
            border-radius: 0.5rem;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        }

        .book-info h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .book-info p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .book-info .description {
            margin-top: 1.5rem;
            line-height: 1.6;
        }

        .booktalk-section {
            padding: 1.5rem;
            min-height: 400px; /* ìµœì†Œ ë†’ì´ ì¶”ê°€ */
        }

        .reacted {
            font-weight: bold;
            color: #007bff;
        }

        .reaction-btn {
            cursor: pointer;
            user-select: none;
            border: 1px solid #ced4da;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        @media (max-width: 767.98px) {
            .book-info h1 {
                font-size: 1.75rem;
            }

            .book-detail-container {
                margin-top: 1rem;
            }
        }

        .skeleton-image {
            width: 100%;
            height: 350px;
            border-radius: 0.5rem;
        }

        .talk-content-text {
            white-space: pre-wrap;
            word-break: break-word;
        }

        @media (max-width: 380px) {
            .reaction-buttons-container {
                display: flex;
                flex-direction: column;
                align-items: flex-end; /* ë²„íŠ¼ ì˜¤ë¥¸ìª½ ì •ë ¬ */
            }

            .reaction-buttons-container .reaction-btn {
                margin-right: 0 !important; /* ì˜¤ë¥¸ìª½ ë§ˆì§„ ì œê±° */
                margin-bottom: 0.5rem; /* ìŒ“ì¸ ë²„íŠ¼ ì‚¬ì´ì— ê³µê°„ ì¶”ê°€ */
            }

            .reaction-buttons-container .reaction-btn:last-child {
                margin-bottom: 0; /* ë§ˆì§€ë§‰ ë²„íŠ¼ì—ëŠ” ë§ˆì§„ ì—†ìŒ */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- ê³µí†µ ê²€ìƒ‰ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€ -->
    <div th:replace="~{fragments/search :: book-search}"></div>

    <div class="content-box book-detail-container">
        <h2 class="mb-3">ë„ì„œ ìƒì„¸ì •ë³´</h2>
        <div class="row">
            <div class="col-12 col-md-4 text-center">
                <!-- ì´ë¯¸ì§€ ìŠ¤ì¼ˆë ˆí†¤, JSë¡œ ëŒ€ì²´ë¨ -->
                <div id="book-image-container">
                    <div class="skeleton skeleton-image"></div>
                </div>
                <img alt="Book cover" class="book-image d-none" id="book-image" src="">
            </div>
            <div class="col-12 col-md-8 book-info mt-3 mt-md-0">
                <!-- í…ìŠ¤íŠ¸ ìŠ¤ì¼ˆë ˆí†¤, JSë¡œ ëŒ€ì²´ë¨ -->
                <h1 id="book-title">
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                </h1>
                <p><strong>ì €ì:</strong> <span id="book-author"><span class="skeleton skeleton-text d-inline-block"
                                                                     style="width: 40%;"></span></span></p>
                <p><strong>ISBN:</strong> <span id="book-isbn"><span class="skeleton skeleton-text d-inline-block"
                                                                     style="width: 50%;"></span></span></p>
                <div class="description" id="book-description">
                    <div class="skeleton skeleton-text" style="width: 100%;"></div>
                    <div class="skeleton skeleton-text" style="width: 100%;"></div>
                    <div class="skeleton skeleton-text" style="width: 70%;"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- ë¶í†¡ ì„¹ì…˜ -->
    <div class="content-box booktalk-section mt-5">
        <h2>ë¶í†¡ <small class="text-muted">BookTalk</small></h2>

        <!-- ë¶í†¡ ê²Œì‹œ ì–‘ì‹ -->
        <form class="mt-4 mb-4" id="talk-form">
            <div class="mb-3">
                <textarea class="form-control" id="talk-content" maxlength="250" placeholder="ë¶í†¡ì„ ë‚¨ê²¨ì£¼ì„¸ìš”... (ìµœëŒ€ 250ì)"
                          required rows="3"></textarea>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted" data-bs-placement="top" data-bs-toggle="tooltip"
                      title="ì´ ê¸€ì€ 12ê°œì›” í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€ë©ë‹ˆë‹¤.">
                    ğŸ•—
                </span>
                <button class="btn btn-primary" type="submit">ë“±ë¡</button>
            </div>
        </form>
        <hr/>

        <div class="mt-3" id="talks-container"></div>
        <nav class="mt-3" id="talks-pagination"></nav>
    </div>
</div>

<script type="module">
    import * as api from '/js/api.js';

    // --- ìƒìˆ˜ ë° ìƒíƒœ ---
    const bookId = window.location.pathname.split('/').pop();
    const talksContainer = document.getElementById('talks-container');
    const talksPaginationContainer = document.getElementById('talks-pagination');
    const talkForm = document.getElementById('talk-form');
    const talkContentInput = document.getElementById('talk-content');
    let currentPage = 0;

    // --- ì´ˆê¸°í™” ---
    document.addEventListener('DOMContentLoaded', () => {

        if (bookId) {
            fetchBookDetails(bookId);
            fetchTalks(bookId, 0);
        }
        initializeTooltips();
        setupEventListeners();
    });

    function initializeTooltips() {
        const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    function setupEventListeners() {
        talkForm.addEventListener('submit', handleTalkSubmit);
        talksPaginationContainer.addEventListener('click', handlePaginationClick);
        talksContainer.addEventListener('click', handleReactionContainerClick);
    }

    // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    async function handleTalkSubmit(e) {
        e.preventDefault();
        const content = talkContentInput.value;
        if (!content) return;
        try {
            await api.postTalk(bookId, content);
            talkContentInput.value = '';
            await fetchTalks(bookId, 0);
        } catch (error) {
            console.error('Error posting talk:', error);
            alert(error.message);
        }
    }

    function handlePaginationClick(e) {

        if (e.target.tagName === 'A' && e.target.dataset.page) {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page, 10);
            fetchTalks(bookId, page);
        }
    }

    function handleReactionContainerClick(e) {
        const target = e.target.closest('.reaction-btn');
        if (target) {
            const {talkId, reactionType, reacted} = target.dataset;
            handleReactionClick(target, talkId, reactionType, reacted === 'true');
        }
    }

    async function handleReactionClick(element, talkId, reactionType, hasReacted) {
        try {
            const response = await api.handleReaction(talkId, reactionType, hasReacted);
            if (!response.ok) {
                return await handleReactionError(response);
            }
            updateReactionUI(element, hasReacted);
        } catch (error) {
            console.error('Error processing reaction:', error);
            alert(error.message);
            await fetchTalks(bookId, currentPage); // ì‹¤íŒ¨ ì‹œ ì„œë²„ì™€ ì¬ë™ê¸°í™”
        }
    }

    // --- ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ---
    async function fetchBookDetails(id) {

        try {
            const book = await api.getBookDetails(id);
            renderBookDetail(book);
        } catch (error) {
            console.error('Error fetching book details:', error);
            document.querySelector('.book-detail-container').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    async function fetchTalks(id, page) {
        currentPage = page;
        renderTalksSkeleton();

        try {
            const pageData = await api.getTalks(id, page);
            renderTalksPage(pageData);
        } catch (error) {
            console.error('Error fetching talks:', error);
            talksContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    // --- UI ë Œë”ë§ ---
    function renderBookDetail(book) {
        document.title = `${book.title} - Quiet Chatter`;

        renderBookImage(book);

        document.getElementById('book-title').textContent = book.title;
        document.getElementById('book-author').textContent = book.author;
        document.getElementById('book-isbn').textContent = book.isbn;
        document.getElementById('book-description').textContent = book.description;
    }

    function renderBookImage(book) {
        const bookImage = document.getElementById('book-image');
        const bookImageContainer = document.getElementById('book-image-container');
        if (!book.thumbnailImageUrl) {
            bookImage.closest('.col-12').style.display = 'none';
            return;
        }

        bookImage.src = book.thumbnailImageUrl;
        bookImage.alt = book.title;
        bookImage.classList.remove('d-none');
        bookImageContainer.classList.add('d-none');

        if (book.externalLinkUrl) {
            const link = document.createElement('a');
            link.href = book.externalLinkUrl;
            link.target = '_blank';
            if (!bookImage.parentNode.isEqualNode(link)) {
                bookImage.parentNode.insertBefore(link, bookImage);
                link.appendChild(bookImage);
            }
        }
    }

    function renderTalksPage(pageData) {
        if (pageData && pageData.content && pageData.content.length > 0) {
            renderTalks(pageData.content);
            renderTalksPagination(pageData.pageInfo);
        } else {
            talksContainer.innerHTML = '<p class="text-muted">ì‘ì„±ëœ ë¶í†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            renderTalksPagination({totalPages: 0});
        }
    }

    function renderTalks(talks) {
        talksContainer.innerHTML = talks.map(talk => `
            <div class="card mb-2">
                <div class="card-body">
                    <p class="card-text talk-content-text">${talk.content}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${talk.getFormattedCreatedAt()}</small>
                        <div class="reaction-buttons-container">
                            <span class="reaction-btn me-3 ${talk.didILike ? 'reacted' : ''}" data-talk-id="${talk.id}" data-reaction-type="LIKE" data-reacted="${talk.didILike}">
                                ğŸ‘ <span class="count">${talk.like_count}</span>
                            </span>
                            <span class="reaction-btn ${talk.didISupport ? 'reacted' : ''}" data-talk-id="${talk.id}" data-reaction-type="SUPPORT" data-reacted="${talk.didISupport}">
                                â¤ï¸ <span class="count">${talk.support_count}</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>`).join('');
    }

    function renderTalksPagination(pageInfo) {
        talksPaginationContainer.innerHTML = '';
        if (pageInfo.totalPages <= 1) return;
        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center';

        if (pageInfo.number > 0) {
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item';
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${pageInfo.number - 1}">ì´ì „</a>`;
            ul.appendChild(prevLi);
        }
        const maxPagesToShow = 10;
        let startPage = Math.max(0, pageInfo.number - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(pageInfo.totalPages - 1, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(0, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === pageInfo.number ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i + 1}</a>`;
            ul.appendChild(li);

        }

        if (pageInfo.number < pageInfo.totalPages - 1) {
            const nextLi = document.createElement('li');

            nextLi.className = 'page-item';
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${pageInfo.number + 1}">ë‹¤ìŒ</a>`;
            ul.appendChild(nextLi);
        }
        talksPaginationContainer.appendChild(ul);

    }


    function renderTalksSkeleton(count = 6) {
        talksContainer.innerHTML = Array(count).fill(0).map(() => `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="skeleton skeleton-text" style="width: 30%;"></div>
                        <div class="d-flex">
                            <div class="skeleton skeleton-text me-3" style="width: 50px;"></div>
                            <div class="skeleton skeleton-text" style="width: 50px;"></div>
                        </div>
                    </div>
                </div>
            </div>`).join('');

    }

    function updateReactionUI(element, hasReacted) {
        const countSpan = element.querySelector('.count');
        const currentCount = parseInt(countSpan.textContent, 10);
        const reacted = !hasReacted;

        element.classList.toggle('reacted', reacted);
        element.dataset.reacted = reacted;

        countSpan.textContent = reacted ? currentCount + 1 : currentCount - 1;
    }

    // --- ì˜¤ë¥˜ ì²˜ë¦¬ ---
    async function handleReactionError(response) {
        if (response.status === 401 || response.status === 403) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        const err = await response.json().catch(() => ({message: 'ë¦¬ì•¡ì…˜ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'}));
        throw new Error(err.message);
    }

</script>

<th:block th:replace="~{fragments/common-assets :: js}"></th:block>
</body>
</html>
