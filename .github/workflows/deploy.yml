# .github/workflows/deploy.yml
name: Spring Boot Docker Deployment to Lightsail

on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew bootJar

      # --- Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ---
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/quiet-chatter:latest
          # Dockerfile ê²½ë¡œê°€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìˆë‹¤ê³  ê°€ì •

      # --- Lightsail ì„œë²„ì— ë°°í¬ (SSH) ---
      - name: Deploy to Lightsail Server via SSH
        uses: appleboy/ssh-action@v1.0.3 # SSH ì—°ê²° ë° ëª…ë ¹ì–´ ì‹¤í–‰ ì•¡ì…˜
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            # 1. ìƒˆ ì´ë¯¸ì§€ ì´ë¦„ ì •ì˜
            IMAGE_REPO=${{ secrets.DOCKER_USERNAME }}/quiet-chatter # ì´ë¯¸ì§€ ì €ì¥ì†Œ ì´ë¦„ (ë³€ê²½ ì—†ìŒ)
            CONTAINER_NAME=quiet-chatter # ğŸ‘ˆ ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•  ì§§ì€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
            IMAGE_TAG=latest
            
            # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ (CONTAINER_NAME ì‚¬ìš©)
            echo "Stopping and removing existing container..."
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            # 3. ìƒˆë¡œìš´ Docker ì´ë¯¸ì§€ Pull (IMAGE_REPO ì‚¬ìš©)
            echo "Pulling new image: $IMAGE_REPO:$IMAGE_TAG"
            docker pull $IMAGE_REPO:$IMAGE_TAG
            
            # 4. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (CONTAINER_NAME ë° IMAGE_REPO ì‚¬ìš©)
            echo "Starting new container..."
            docker run -d \
              --name $CONTAINER_NAME \
              -p 8080:8080 \
              -e SPRING_DATA_MONGODB_HOST=mongodb \
              -e SPRING_DATA_MONGODB_PORT=27017 \
              -e SPRING_DATA_MONGODB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e SPRING_DATA_MONGODB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e SPRING_DATA_MONGODB_DATABASE=${{ secrets.DB_NAME }} \
              $IMAGE_REPO:$IMAGE_TAG
            
            echo "Deployment finished."
